<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Suhoor to Iftar">
<meta name="theme-color" content="#2e8b57">
<link rel="manifest" href="manifest.json">
<title>Suhoor to Iftar</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700&family=Lateef:wght@400;500;600;700&display=swap');
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;touch-action:none;}
body{
  font-family:'Inter',system-ui,sans-serif;
  color:#e0e8e4;
  -webkit-font-smoothing:antialiased;
}
canvas{position:fixed;top:0;left:0;width:100vw;height:100vh;display:block;}

.info{position:fixed;left:50%;transform:translateX(-50%) translateY(8px);z-index:10;text-align:center;display:flex;flex-direction:column;align-items:center;gap:2px;pointer-events:none;opacity:0;transition:opacity .5s cubic-bezier(.4,0,.2,1),transform .5s cubic-bezier(.4,0,.2,1);}
.info-top{top:max(20px,env(safe-area-inset-top,0px));}
.info-bottom{bottom:max(36px,calc(env(safe-area-inset-bottom,0px) + 28px));}
.info.visible{opacity:1;transform:translateX(-50%) translateY(0);}
.info>*{pointer-events:auto;}
.ramadan-label{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.25em;transition:all .5s;}
.hijri{font-size:clamp(18px,3vw,28px);font-weight:200;letter-spacing:.02em;transition:all .5s;}
.greg{font-size:clamp(11px,1.5vw,14px);font-weight:300;letter-spacing:.03em;opacity:.6;transition:all .5s;}
.fast-status{font-size:clamp(12px,1.8vw,18px);font-weight:300;margin-top:2px;letter-spacing:.02em;transition:all .5s;}
.fast-status .tl{font-variant-numeric:tabular-nums;font-weight:500;transition:all .5s;}
.prayers{display:flex;gap:clamp(10px,2vw,20px);flex-wrap:wrap;justify-content:center;margin-top:8px;font-family:'Inter',system-ui,-apple-system,sans-serif;letter-spacing:.06em;font-weight:400;text-transform:uppercase;transition:all .5s;}
.pp{display:inline-flex;align-items:center;gap:5px;font-weight:400;letter-spacing:.04em;padding:0;border:none!important;background:none!important;backdrop-filter:none;transition:all .5s;opacity:.5;}
.pp.next{opacity:1;font-weight:500;}
.pp .dot{width:5px;height:5px;border-radius:50%;flex-shrink:0;}
.pp .pt{font-weight:400;font-variant-numeric:tabular-nums;}
.pp.next .pt{font-weight:500;}
.loc{font-size:clamp(9px,1.2vw,11px);font-weight:400;letter-spacing:.06em;margin-top:4px;opacity:.4;transition:all .5s;text-transform:uppercase;}
.settings-btn{position:fixed;top:max(16px,env(safe-area-inset-top,0px));right:16px;z-index:15;width:32px;height:32px;cursor:pointer;opacity:0.2;transition:opacity .3s;}
.settings-btn:hover,.settings-btn:active{opacity:0.5;}
.settings-btn svg{width:100%;height:100%;}

/* Settings overlay â€” iOS sheet */
.sov{display:none;position:fixed;inset:0;backdrop-filter:blur(40px) saturate(180%);-webkit-backdrop-filter:blur(40px) saturate(180%);z-index:100;align-items:center;justify-content:center;transition:background .5s;}
.sov.open{display:flex;}
.scard{border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:24px 28px;width:min(88vw,380px);max-height:80vh;overflow-y:auto;transition:all .5s;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);}
.scard h3{font-size:13px;font-weight:600;margin-bottom:20px;text-transform:uppercase;letter-spacing:.1em;text-align:center;}
.sr{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.06);}
.sr:last-child{border-bottom:none;}
.sl{font-size:13px;font-weight:400;}
.sv{font-size:13px;border:1px solid rgba(255,255,255,.12);border-radius:8px;padding:6px 12px;background:rgba(255,255,255,.06);}
select.sv{-webkit-appearance:none;appearance:none;padding-right:24px;}
input.sv{width:120px;}
.sbtn{margin-top:20px;width:100%;padding:12px;font-size:13px;font-weight:500;border-radius:12px;cursor:pointer;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.08);letter-spacing:.03em;}

/* Lume color picker grid */
.lume-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:8px;}
.lume-swatch{width:100%;aspect-ratio:1;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:border-color .2s;}
.lume-swatch.active{border-color:rgba(255,255,240,.8);}

/* Movement preview */
.movement-row{display:flex;gap:8px;align-items:center;}
.movement-opt{flex:1;text-align:center;padding:8px 4px;border-radius:8px;cursor:pointer;font-size:11px;border:1px solid;transition:all .2s;}
.movement-opt.active{font-weight:600;}

/* Dial Picker Bar */
.dial-dots{position:fixed;bottom:max(10px,env(safe-area-inset-bottom,0px));left:50%;transform:translateX(-50%);display:flex;gap:6px;z-index:20;opacity:0;transition:opacity .4s cubic-bezier(.4,0,.2,1);pointer-events:none;}
.dial-dots.visible{opacity:1;}
.dial-dot{width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,.2);transition:all .4s cubic-bezier(.4,0,.2,1);}
.dial-dot.active{background:rgba(255,255,255,.85);transform:scale(1.15);}
</style>
</head>
<body>

<canvas id="c"></canvas>

<div class="settings-btn" onclick="openSettings()">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="12" cy="12" r="3"/>
    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
  </svg>
</div>

<div id="tapOverlay" style="position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);backdrop-filter:blur(30px) saturate(180%);-webkit-backdrop-filter:blur(30px) saturate(180%);cursor:pointer;transition:opacity .6s cubic-bezier(.4,0,.2,1);">
  <div style="text-align:center;color:rgba(255,255,240,.85);max-width:320px;padding:0 24px;">
    <div style="font-size:clamp(36px,6vw,52px);margin-bottom:4px;">â˜½</div>
    <div style="font-size:clamp(9px,1.3vw,11px);font-weight:600;letter-spacing:.25em;text-transform:uppercase;opacity:.5;margin-bottom:20px;">Suhoor to Iftar</div>
    
    <div style="display:flex;flex-direction:column;gap:18px;margin:28px 0;">
      <div style="display:flex;align-items:center;gap:16px;">
        <div style="width:48px;height:48px;border-radius:50%;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,240,.6)" stroke-width="1.5" stroke-linecap="round"><circle cx="12" cy="12" r="2.5"/><path d="M12 6v1m0 10v1m-6-6h1m10 0h1"/></svg>
        </div>
        <div style="text-align:left;">
          <div style="font-size:clamp(12px,1.6vw,14px);font-weight:400;letter-spacing:.02em;">Tap</div>
          <div style="font-size:clamp(10px,1.3vw,12px);font-weight:300;opacity:.4;margin-top:2px;">Prayer times & info</div>
        </div>
      </div>
      
      <div style="display:flex;align-items:center;gap:16px;">
        <div style="width:48px;height:48px;border-radius:50%;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
          <svg width="22" height="18" viewBox="0 0 28 20" fill="none" stroke="rgba(255,255,240,.6)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 10H2l4-4M2 10l4 4"/><path d="M20 10h6l-4-4M26 10l-4 4"/></svg>
        </div>
        <div style="text-align:left;">
          <div style="font-size:clamp(12px,1.6vw,14px);font-weight:400;letter-spacing:.02em;">Swipe left Â· right</div>
          <div style="font-size:clamp(10px,1.3vw,12px);font-weight:300;opacity:.4;margin-top:2px;">Change watch face</div>
        </div>
      </div>
      
      <div style="display:flex;align-items:center;gap:16px;">
        <div style="width:48px;height:48px;border-radius:50%;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,240,.6)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 4v10"/><path d="M8 8l4-4 4 4"/></svg>
        </div>
        <div style="text-align:left;">
          <div style="font-size:clamp(12px,1.6vw,14px);font-weight:400;letter-spacing:.02em;">Swipe up</div>
          <div style="font-size:clamp(10px,1.3vw,12px);font-weight:300;opacity:.4;margin-top:2px;">Day mode</div>
        </div>
      </div>
      
      <div style="display:flex;align-items:center;gap:16px;">
        <div style="width:48px;height:48px;border-radius:50%;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,240,.6)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20V10"/><path d="M8 16l4 4 4-4"/></svg>
        </div>
        <div style="text-align:left;">
          <div style="font-size:clamp(12px,1.6vw,14px);font-weight:400;letter-spacing:.02em;">Swipe down</div>
          <div style="font-size:clamp(10px,1.3vw,12px);font-weight:300;opacity:.4;margin-top:2px;">Night mode</div>
        </div>
      </div>
    </div>
    
    <div style="font-size:clamp(11px,1.4vw,13px);font-weight:300;letter-spacing:.06em;opacity:.35;margin-top:8px;">tap anywhere to begin</div>
  </div>
</div>

<div class="info info-top">
  <div class="ramadan-label" id="ramLabel"></div>
  <div class="hijri" id="hijri"></div>
  <div class="greg" id="greg"></div>
  <div class="loc" id="loc" onclick="openSettings()">Loadingâ€¦</div>
</div>
<div class="info info-bottom">
  <div class="fast-status" id="fastStatus"></div>
  <div class="prayers" id="prayers"></div>
</div>

<div class="dial-dots" id="dialDots"></div>

<div class="sov" id="sov" onclick="if(event.target===this)closeSettings()">
  <div class="scard" id="scard">
    <h3 id="settingsTitle">â˜ª Settings</h3>

    <div class="sr"><span class="sl">City</span><input class="sv" id="sCity" value="Los Angeles"></div>
    <div class="sr"><span class="sl">Country</span><input class="sv" id="sCountry" value="US"></div>
    <div class="sr"><span class="sl">Calculation</span>
      <select class="sv" id="sMethod">
        <option value="2" selected>ISNA</option><option value="1">Karachi</option>
        <option value="3">MWL</option><option value="4">Umm Al-Qura</option>
        <option value="5">Egyptian</option><option value="7">Tehran</option>
        <option value="8">Gulf</option><option value="15">Moonsighting</option>
      </select>
    </div>
    <div class="sr"><span class="sl">Numerals</span>
      <select class="sv" id="sNum">
        <option value="arabic" selected>Arabic-Indic</option>
        <option value="western">Western</option>
        <option value="both">Both</option>
        <option value="none">None</option>
      </select>
    </div>
    <div class="sr"><span class="sl">Movement</span>
      <div class="movement-row">
        <div class="movement-opt" data-mv="quartz" onclick="setMovement('quartz')">Quartz</div>
        <div class="movement-opt" data-mv="mechanical" onclick="setMovement('mechanical')">Mechanical</div>
        <div class="movement-opt" data-mv="digital" onclick="setMovement('digital')">Digital</div>
      </div>
    </div>
    <div class="sr" style="flex-direction:column;align-items:flex-start;gap:8px;">
      <div style="display:flex;justify-content:space-between;width:100%;align-items:center;">
        <span class="sl">Spatial Audio Volume</span>
        <span class="sl" id="volLabel" style="opacity:0.5;">100%</span>
      </div>
      <input type="range" id="volSlider" min="0" max="100" value="100" oninput="setTickVol(this.value)" style="width:100%;accent-color:currentColor;height:2px;opacity:0.7;">
      <span style="font-size:9px;opacity:0.35;margin-top:-4px;">HRTF 3D spatial audio Â· best with headphones</span>
    </div>
    <div class="sr"><span class="sl">Mode</span>
      <div class="movement-row">
        <div class="movement-opt" data-mode="auto" onclick="setMode('auto')">Auto</div>
        <div class="movement-opt" data-mode="day" onclick="setMode('day')">Day</div>
        <div class="movement-opt" data-mode="night" onclick="setMode('night')">Night</div>
      </div>
    </div>
    <div id="lumeSection" style="display:none;">
      <div class="sr" style="flex-direction:column;align-items:flex-start;gap:8px;">
        <span class="sl">Lume Color</span>
        <div class="lume-grid" id="lumeGrid"></div>
      </div>
    </div>
    <div class="sr"><span class="sl">Dial</span>
      <select class="sv" id="sDial">
        <option value="tennis" selected>Tennis</option>
        <option value="white">White</option>
        <option value="ocean">Ocean</option>
        <option value="salmon">Salmon</option>
        <option value="slate">Slate</option>
        <option value="sky">Sky Blue</option>
        <option value="cream">Cream</option>
        <option value="noir">Noir</option>
        <option value="emerald">Emerald</option>
        <option value="midnight">Midnight</option>
      </select>
    </div>
    <button class="sbtn" id="saveBtn" onclick="saveSettings()">Save & Refresh</button>
  </div>
</div>

<script>
const cv=document.getElementById('c');
const ctx=cv.getContext('2d');
let dpr=window.devicePixelRatio||1;
let W,H,cx,cy,R;

// â”€â”€ Dial Color Systems â”€â”€
const DIALS={
  tennis:  {bg:'#2e8b57',lume:'#c8e860',lumeDim:'#6aaa50',hand:'#f4f0e0',handStroke:'#ffffff',shadow:'rgba(0,40,20,.25)',minNum:'rgba(200,232,96,.35)',text:'rgba(255,255,240,.7)',textDim:'rgba(255,255,240,.35)',textMuted:'rgba(255,255,240,.25)',accent:'#f0e060',pillBg:'rgba(0,0,0,.08)',pillBorder:'rgba(255,255,240,.08)',cardBg:'rgba(20,60,35,.95)',cardBorder:'rgba(255,255,240,.1)'},
  white:   {bg:'#e8e4dc',lume:'#1a1a1a',lumeDim:'#888',hand:'#111',handStroke:'#222',shadow:'rgba(0,0,0,.12)',minNum:'rgba(0,0,0,.2)',text:'rgba(0,0,0,.6)',textDim:'rgba(0,0,0,.3)',textMuted:'rgba(0,0,0,.15)',accent:'#c8a040',pillBg:'rgba(0,0,0,.04)',pillBorder:'rgba(0,0,0,.08)',cardBg:'rgba(240,236,228,.95)',cardBorder:'rgba(0,0,0,.08)'},
  salmon:  {bg:'#c47a60',lume:'#fff0e0',lumeDim:'#d4a890',hand:'#f8f4ec',handStroke:'#fff',shadow:'rgba(60,20,10,.2)',minNum:'rgba(255,240,224,.3)',text:'rgba(255,240,224,.7)',textDim:'rgba(255,240,224,.35)',textMuted:'rgba(255,240,224,.2)',accent:'#f0d060',pillBg:'rgba(0,0,0,.06)',pillBorder:'rgba(255,240,224,.1)',cardBg:'rgba(140,80,55,.95)',cardBorder:'rgba(255,240,224,.1)'},
  slate:   {bg:'#3a3a44',lume:'#c0c0ca',lumeDim:'#6a6a74',hand:'#e0e0e4',handStroke:'#f0f0f4',shadow:'rgba(0,0,0,.25)',minNum:'rgba(192,192,202,.3)',text:'rgba(224,224,228,.6)',textDim:'rgba(224,224,228,.3)',textMuted:'rgba(224,224,228,.15)',accent:'#a0a0b0',pillBg:'rgba(0,0,0,.1)',pillBorder:'rgba(224,224,228,.08)',cardBg:'rgba(45,45,55,.95)',cardBorder:'rgba(224,224,228,.08)'},
  sky:     {bg:'#5a9ac0',lume:'#f0f8ff',lumeDim:'#8abcda',hand:'#f4f0e8',handStroke:'#fff',shadow:'rgba(0,20,40,.2)',minNum:'rgba(240,248,255,.3)',text:'rgba(240,248,255,.7)',textDim:'rgba(240,248,255,.35)',textMuted:'rgba(240,248,255,.2)',accent:'#f0e060',pillBg:'rgba(0,0,0,.06)',pillBorder:'rgba(240,248,255,.1)',cardBg:'rgba(60,110,150,.95)',cardBorder:'rgba(240,248,255,.1)'},
  cream:   {bg:'#d8ccb4',lume:'#3a3530',lumeDim:'#8a8478',hand:'#2a2520',handStroke:'#3a3530',shadow:'rgba(0,0,0,.1)',minNum:'rgba(58,53,48,.25)',text:'rgba(58,53,48,.6)',textDim:'rgba(58,53,48,.3)',textMuted:'rgba(58,53,48,.15)',accent:'#b08840',pillBg:'rgba(0,0,0,.04)',pillBorder:'rgba(58,53,48,.1)',cardBg:'rgba(200,188,168,.95)',cardBorder:'rgba(58,53,48,.1)'},
};

// Lume colors for night mode
const LUME_COLORS=[
  {name:'Green',color:'#c8e860'},
  {name:'White',color:'#e0e0e4'},
  {name:'Blue',color:'#60a0e0'},
  {name:'Orange',color:'#e0a040'},
  {name:'Cyan',color:'#40d8d0'},
  {name:'Red',color:'#d04040'},
  {name:'Lavender',color:'#a080e0'},
  {name:'Gold',color:'#d4a017'},
  {name:'Salmon',color:'#e08070'},
  {name:'Pink',color:'#e070a0'},
  {name:'Mint',color:'#60d8a0'},
  {name:'Yellow',color:'#e0d060'},
  {name:'Ice',color:'#a0d0f0'},
  {name:'Amber',color:'#d0a030'},
];

// â”€â”€ Settings â”€â”€
function loadS(){
  try{
    const s=JSON.parse(localStorage.getItem('rc6')||'{}');
    return{
      city:s.city||'Los Angeles',country:s.country||'US',method:s.method||'2',
      numerals:s.numerals||'arabic',movement:s.movement||'quartz',tickVol:s.tickVol!=null?s.tickVol:100,
      mode:s.mode||'day',dial:s.dial||'tennis',lumeColor:s.lumeColor||0,
    };
  }catch(e){
    return{city:'Los Angeles',country:'US',method:'2',numerals:'arabic',movement:'quartz',tickVol:100,mode:'auto',dial:'tennis',lumeColor:0};
  }
}
let S=loadS();
let D=DIALS[S.dial]; // active dial colors

// Smooth dayâ†”night transition
let modeBlend=0; // 0=day, 1=night
let modeTarget=0;
function updateModeBlend(){
  const target=resolveMode()==='night'?1:0;
  modeTarget=target;
}
function lerpColor(a,b,t){
  // Parse hex or rgb
  const pa=parseCol(a),pb=parseCol(b);
  if(!pa||!pb)return t<0.5?a:b;
  return`rgb(${Math.round(pa[0]+(pb[0]-pa[0])*t)},${Math.round(pa[1]+(pb[1]-pa[1])*t)},${Math.round(pa[2]+(pb[2]-pa[2])*t)})`;
}
function parseCol(c){
  if(!c)return null;
  if(c.startsWith('#')){
    const h=c.length===4?c[1]+c[1]+c[2]+c[2]+c[3]+c[3]:c.slice(1);
    return[parseInt(h.slice(0,2),16),parseInt(h.slice(2,4),16),parseInt(h.slice(4,6),16)];
  }
  const m=c.match(/(\d+)/g);
  return m?m.slice(0,3).map(Number):null;
}
function lerpVal(a,b,t){return a+(b-a)*t;}
function colAlpha(col,a){const p=parseCol(col);if(!p)return col;return`rgba(${p[0]},${p[1]},${p[2]},${a})`;}

function getColors(){
  // Animate blend toward target
  modeBlend+=(modeTarget-modeBlend)*0.04; // smooth ease
  if(Math.abs(modeBlend-modeTarget)<0.001)modeBlend=modeTarget;
  
  const day=DIALS[S.dial];
  if(modeBlend<0.001)return day;
  
  const lc=LUME_COLORS[S.lumeColor].color;
  const r=parseInt(lc.slice(1,3),16),g=parseInt(lc.slice(3,5),16),b=parseInt(lc.slice(5,7),16);
  const dim=`rgb(${Math.floor(r*.4)},${Math.floor(g*.4)},${Math.floor(b*.4)})`;
  const night={
    bg:'#000000',lume:lc,lumeDim:dim,hand:lc,handStroke:lc,
    shadow:'rgba(0,0,0,.5)',minNum:`rgba(${r},${g},${b},.2)`,
    text:`rgba(${r},${g},${b},.5)`,textDim:`rgba(${r},${g},${b},.25)`,
    textMuted:`rgba(${r},${g},${b},.12)`,accent:lc,
    pillBg:'rgba(255,255,255,.02)',pillBorder:`rgba(${r},${g},${b},.1)`,
    cardBg:'rgba(10,10,10,.95)',cardBorder:`rgba(${r},${g},${b},.1)`,
  };
  if(modeBlend>0.999)return night;
  
  // Interpolate all colors
  const t=modeBlend;
  return{
    bg:lerpColor(day.bg,night.bg,t),
    lume:lerpColor(day.lume,night.lume,t),
    lumeDim:lerpColor(day.lumeDim,night.lumeDim,t),
    hand:lerpColor(day.hand,night.hand,t),
    handStroke:lerpColor(day.handStroke,night.handStroke,t),
    shadow:t<0.5?day.shadow:night.shadow,
    minNum:t<0.5?day.minNum:night.minNum,
    text:t<0.5?day.text:night.text,
    textDim:t<0.5?day.textDim:night.textDim,
    textMuted:t<0.5?day.textMuted:night.textMuted,
    accent:lerpColor(day.accent,night.accent,t),
    pillBg:t<0.5?day.pillBg:night.pillBg,
    pillBorder:t<0.5?day.pillBorder:night.pillBorder,
    cardBg:t<0.5?day.cardBg:night.cardBg,
    cardBorder:t<0.5?day.cardBorder:night.cardBorder,
  };
}

// Pixel shift for burn-in protection
let pixelShiftX=0, pixelShiftY=0, lastShift=0;
function updatePixelShift(){
  const now=Date.now();
  if(now-lastShift>120000){ // every 2 minutes
    pixelShiftX=Math.round((Math.random()-0.5)*4);
    pixelShiftY=Math.round((Math.random()-0.5)*4);
    lastShift=now;
  }
}

window.openSettings=()=>{
  document.getElementById('sCity').value=S.city;
  document.getElementById('sCountry').value=S.country;
  document.getElementById('sMethod').value=S.method;
  document.getElementById('sNum').value=S.numerals;
  document.getElementById('sDial').value=S.dial;
  updateSettingsUI();
  document.getElementById('sov').classList.add('open');
};
window.closeSettings=()=>document.getElementById('sov').classList.remove('open');
window.saveSettings=()=>{
  S.city=document.getElementById('sCity').value.trim()||'Los Angeles';
  S.country=document.getElementById('sCountry').value.trim()||'US';
  S.method=document.getElementById('sMethod').value;
  S.numerals=document.getElementById('sNum').value;
  S.dial=document.getElementById('sDial').value;
  localStorage.setItem('rc6',JSON.stringify(S));
  D=getColors();
  applyThemeToUI();
  closeSettings();
  fetchPrayer();
};
window.setMovement=mv=>{S.movement=mv;updateSettingsUI();};
window.setTickVol=v=>{S.tickVol=parseInt(v);document.getElementById('volLabel').textContent=v+'%';};
window.setMode=mode=>{
  S.mode=mode;
  updateModeBlend();
  const effectiveMode=resolveMode();
  document.getElementById('lumeSection').style.display=effectiveMode==='night'?'block':'none';
  updateSettingsUI();
  localStorage.setItem('rc6',JSON.stringify(S));
};
// Resolve auto mode using prayer times: night between Maghribâ†’Fajr
function resolveMode(){
  if(S.mode!=='auto')return S.mode;
  if(!PD)return 'day';
  const now=nM(),fajr=pM(PD.Fajr),mag=pM(PD.Maghrib);
  return (now>=fajr&&now<mag)?'day':'night';
}

function updateSettingsUI(){
  document.querySelectorAll('.movement-opt[data-mv]').forEach(el=>{
    el.classList.toggle('active',el.dataset.mv===S.movement);
  });
  document.querySelectorAll('.movement-opt[data-mode]').forEach(el=>{
    el.classList.toggle('active',el.dataset.mode===S.mode);
  });
  document.getElementById('lumeSection').style.display=resolveMode()==='night'?'block':'none';
  document.getElementById('volSlider').value=S.tickVol;
  document.getElementById('volLabel').textContent=S.tickVol+'%';
  buildLumeGrid();
}

function buildLumeGrid(){
  const grid=document.getElementById('lumeGrid');
  grid.innerHTML=LUME_COLORS.map((lc,i)=>
    `<div class="lume-swatch ${i===S.lumeColor?'active':''}" style="background:${lc.color}" onclick="setLume(${i})" title="${lc.name}"></div>`
  ).join('');
}
window.setLume=i=>{S.lumeColor=i;buildLumeGrid();};

function applyThemeToUI(){
  const c=getColors();
  document.body.style.background=c.bg;
  const root=document.documentElement;
  root.style.setProperty('--theme-text',c.text);
  root.style.setProperty('--theme-dim',c.textDim);
  root.style.setProperty('--theme-muted',c.textMuted);
  root.style.setProperty('--theme-accent',c.accent);
}

document.addEventListener('keydown',e=>{if(e.key==='Escape')closeSettings();});

// â”€â”€ Prayer â”€â”€
let PD=null,DD=null;
const PC={Fajr:'#6ba0c4',Sunrise:'#e8c060',Dhuhr:'#f0e060',Asr:'#e0b050',Maghrib:'#d06040',Isha:'#8a7abf'};
const PN=['Fajr','Sunrise','Dhuhr','Asr','Maghrib','Isha'];
function pM(s){if(!s)return 0;const[h,m]=s.split(':').map(Number);return h*60+m;}
// â”€â”€ DEV MODE â”€â”€
let devMode=false,devTimeMin=null,devRamadan=false,devLocation=null;
const DEV_LOCATIONS={
  'reykjavik':{label:'Reykjavik ðŸ‡®ðŸ‡¸ (~21h)',city:'Reykjavik',country:'IS',method:'3',summerFajr:'01:30',summerMag:'23:00'},
  'stockholm':{label:'Stockholm ðŸ‡¸ðŸ‡ª (~19h)',city:'Stockholm',country:'SE',method:'3',summerFajr:'01:50',summerMag:'21:30'},
  'london':{label:'London ðŸ‡¬ðŸ‡§ (~18h)',city:'London',country:'GB',method:'3',summerFajr:'02:30',summerMag:'21:15'},
  'la':{label:'Los Angeles ðŸ‡ºðŸ‡¸ (~14h)',city:null,country:null},
  'mecca':{label:'Mecca ðŸ‡¸ðŸ‡¦ (~14h)',city:'Mecca',country:'SA',method:'4'},
  'capetown':{label:'Cape Town ðŸ‡¿ðŸ‡¦ (~11h)',city:'Cape Town',country:'ZA',method:'3'},
};
async function devFetchLocation(key){
  const loc=DEV_LOCATIONS[key];if(!loc)return;
  if(!loc.city){devLocation=null;await fetchPrayer();return;}
  try{
    const r=await fetch(`https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(loc.city)}&country=${encodeURIComponent(loc.country)}&method=${loc.method||S.method}`);
    const j=await r.json();
    if(j.code===200){PD=j.data.timings;DD=j.data.date;devLocation=key;
      if(loc.summerFajr){PD.Fajr=loc.summerFajr;PD.Maghrib=loc.summerMag;PD.Sunrise=loc.summerFajr.replace(/^\d+/,h=>(parseInt(h)+1).toString().padStart(2,'0'));PD.Isha=loc.summerMag.replace(/^\d+/,h=>(parseInt(h)+1).toString().padStart(2,'0'));}
      updateInfo();}
  }catch(e){console.error('Dev fetch failed:',e);}
}
function devNow(){if(devTimeMin!==null){const d=new Date();d.setHours(Math.floor(devTimeMin/60),Math.floor(devTimeMin%60),Math.floor((devTimeMin%1)*60),0);return d;}return new Date();}
function nM(){return devTimeMin!==null?devTimeMin:(()=>{const d=new Date();return d.getHours()*60+d.getMinutes()+d.getSeconds()/60;})();}
function f12(m){const h=Math.floor(m/60),mi=Math.floor(m%60);return`${h%12||12}:${String(mi).padStart(2,'0')}${h>=12?'p':'a'}`;}
const MN={'1':'Karachi','2':'ISNA','3':'MWL','4':'Umm Al-Qura','5':'Egyptian','7':'Tehran','8':'Gulf','15':'Moonsighting'};

async function fetchPrayer(){
  try{const r=await fetch(`https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(S.city)}&country=${encodeURIComponent(S.country)}&method=${S.method}`);const j=await r.json();if(j.code===200){PD=j.data.timings;DD=j.data.date;updateInfo();if(qiblaAngle===null)calcQibla();}}catch(e){document.getElementById('loc').textContent='Failed to load';}
}

function updateInfo(){
  if(!DD)return;
  const c=getColors();
  const h=DD.hijri,g=DD.gregorian;
  document.getElementById('hijri').textContent=`${h.day} ${h.month.en} ${h.year} AH`;
  document.getElementById('hijri').style.color=c.text;
  document.getElementById('greg').textContent=`${g.weekday.en}, ${g.day} ${g.month.en} ${g.year}`;
  document.getElementById('greg').style.color=c.textDim;
  document.getElementById('loc').textContent=`${S.city} Â· ${MN[S.method]||'ISNA'}`;
  document.getElementById('loc').style.color=c.textMuted;
  const lbl=document.getElementById('ramLabel');
  lbl.style.color=c.accent;
  const isRam=devRamadan||h.month.number===9;
  if(isRam)lbl.textContent=`RAMADAN Â· DAY ${devRamadan?'15':h.day}`;
  else if(h.month.number===8){const dl=(h.month.days||30)-parseInt(h.day);lbl.textContent=dl<=15?`${dl} DAYS TO RAMADAN`:`SHA'BÄ€N ${h.day}`;}
  else lbl.textContent='';

  const now=nM();
  const ps=PN.map(n=>({name:n,time:pM(PD[n]),color:PC[n]}));
  let ni=ps.findIndex(p=>p.time>now);if(ni===-1)ni=0;
  let ci=ni-1;if(ci<0)ci=ps.length-1;
  const pEl=document.getElementById('prayers');
  pEl.style.color=c.text||c.textDim;
  pEl.style.fontSize=Math.round(R*0.04/dpr)+'px';
  pEl.innerHTML=ps.map((p,i)=>{
    const cls=i===ni?'pp next':'pp';
    return`<span class="${cls}"><span class="dot" style="background:${i===ni?c.accent:p.color}"></span>${p.name} <span class="pt">${f12(p.time)}</span></span>`;
  }).join('');

  const fajr=pM(PD.Fajr),mag=pM(PD.Maghrib),el=document.getElementById('fastStatus');
  el.style.color=c.text;
  if(isRam){
    if(now>=fajr&&now<mag){const l=mag-now;el.innerHTML=`Fasting Â· <span class="tl" style="color:${c.accent}">${Math.floor(l/60)}h ${Math.floor(l%60)}m to Iftar</span>`;}
    else if(now<fajr){const l=fajr-now;el.innerHTML=`Suhoor Â· <span class="tl" style="color:${c.accent}">${Math.floor(l/60)}h ${Math.floor(l%60)}m to Fajr</span>`;}
    else el.innerHTML=`<span style="color:${c.accent}">Iftar Mubarak â˜ª</span>`;
  }else{el.innerHTML=`Fajr <span class="tl" style="color:${c.accent}">${f12(fajr)}</span> Â· Maghrib <span class="tl" style="color:${c.accent}">${f12(mag)}</span>`;}
}

// â”€â”€ Resize â”€â”€
function resize(){
  dpr=window.devicePixelRatio||1;
  W=window.innerWidth*dpr;H=window.innerHeight*dpr;
  cv.width=W;cv.height=H;
  cv.style.width=window.innerWidth+'px';
  cv.style.height=window.innerHeight+'px';
  cx=W/2;cy=H/2;
  R=Math.min(W,H)*0.42;
}
resize();
window.addEventListener('resize',resize);

// â”€â”€ Qibla â”€â”€
const MECCA_LAT=21.4225*Math.PI/180, MECCA_LNG=39.8262*Math.PI/180;
let userLat=null,userLng=null,deviceHeading=null,qiblaAngle=null;

// City coordinates fallback for Qibla when GPS unavailable
const CITY_COORDS={'los angeles':[34.05,-118.24],'new york':[40.71,-74.01],'london':[51.51,-0.13],'dubai':[25.20,55.27],'cairo':[30.04,31.24],'istanbul':[41.01,28.98],'karachi':[24.86,67.01],'jakarta':[-6.21,106.85],'kuala lumpur':[3.14,101.69],'toronto':[43.65,-79.38],'chicago':[41.88,-87.63],'houston':[29.76,-95.37],'san francisco':[37.77,-122.42],'seattle':[47.61,-122.33],'miami':[25.76,-80.19],'dallas':[32.78,-96.80],'atlanta':[33.75,-84.39],'denver':[39.74,-104.99],'phoenix':[33.45,-112.07],'detroit':[42.33,-83.05],'boston':[42.36,-71.06],'paris':[48.86,2.35],'berlin':[52.52,13.41],'riyadh':[24.71,46.67],'jeddah':[21.54,39.17],'mecca':[21.42,39.83],'medina':[24.47,39.61],'doha':[25.29,51.53],'abu dhabi':[24.45,54.65],'amman':[31.95,35.93],'beirut':[33.89,35.50],'islamabad':[33.69,73.04],'lahore':[31.55,74.35],'dhaka':[23.81,90.41],'singapore':[1.35,103.82],'sydney':[-33.87,151.21],'melbourne':[-37.81,144.96],'cape town':[-33.93,18.42]};

function calcQibla(){
  if(userLat===null){
    // Fallback: use city from settings
    const coords=CITY_COORDS[(S.city||'').toLowerCase()];
    if(coords){userLat=coords[0]*Math.PI/180;userLng=coords[1]*Math.PI/180;}
    else return;
  }
  const dLng=MECCA_LNG-userLng;
  const y=Math.sin(dLng)*Math.cos(MECCA_LAT);
  const x=Math.cos(userLat)*Math.sin(MECCA_LAT)-Math.sin(userLat)*Math.cos(MECCA_LAT)*Math.cos(dLng);
  qiblaAngle=Math.atan2(y,x);
}

function requestGeoForQibla(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(p=>{
      userLat=p.coords.latitude*Math.PI/180;
      userLng=p.coords.longitude*Math.PI/180;
      calcQibla();
    },()=>{/* fallback: no qibla */},{enableHighAccuracy:false,timeout:10000});
  }
}
requestGeoForQibla();

// DeviceOrientation for compass heading
let compassSupported=false,compassInited=false;
function initCompass(){
  if(compassInited)return;compassInited=true;
  // Prefer absolute (Android)
  if('ondeviceorientationabsolute' in window){
    window.addEventListener('deviceorientationabsolute',e=>{
      if(e.alpha!=null){deviceHeading=(360-e.alpha)*Math.PI/180;compassSupported=true;}
    });
  }
  // Fallback / iOS
  window.addEventListener('deviceorientation',e=>{
    if(compassSupported)return;
    if(e.webkitCompassHeading!=null){
      deviceHeading=e.webkitCompassHeading*Math.PI/180;
    }else if(e.alpha!=null&&e.absolute){
      deviceHeading=(360-e.alpha)*Math.PI/180;
    }
  });
}
// Tap-to-start: unlock audio + gyro in one gesture
const tapOverlay=document.getElementById('tapOverlay');
function activateAll(){
  // Audio
  if(!qiblaAudioCtx)qiblaAudioCtx=new(window.AudioContext||window.webkitAudioContext)();
  if(qiblaAudioCtx.state==='suspended')qiblaAudioCtx.resume();
  // Gyro (iOS permission)
  if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){
    DeviceOrientationEvent.requestPermission().then(r=>{if(r==='granted'){compassInited=false;initCompass();}}).catch(()=>{});
  }else{initCompass();}
  // Retry geolocation after user gesture
  if(qiblaAngle===null)requestGeoForQibla();
  // Dismiss overlay
  tapOverlay.style.opacity='0';
  setTimeout(()=>tapOverlay.style.display='none',500);
  // Show info panels + dial bar briefly
  const infos=document.querySelectorAll('.info');
  const bar=document.getElementById('dialBar');
  infoVisible=true;
  infos.forEach(el=>el.classList.add('visible'));
  bar.classList.add('visible');
  clearTimeout(infoTimer);
  infoTimer=setTimeout(()=>{infoVisible=false;infos.forEach(el=>el.classList.remove('visible'));bar.classList.remove('visible');},6000);
}
// iOS requires click (not touchstart) for DeviceOrientation permission
tapOverlay.addEventListener('click',activateAll,{once:true});
// Non-iOS: init compass immediately (no permission needed)
if(typeof DeviceOrientationEvent==='undefined'||typeof DeviceOrientationEvent.requestPermission!=='function'){
  initCompass();
}

let qiblaAligned=false, lastHaptic=0;
// Audio tick for Qibla alignment (iOS has no Vibration API)
let qiblaAudioCtx=null,qiblaWasAligned=false;
// Must create & resume AudioContext from user gesture on iOS
document.addEventListener('touchstart',function unlockAudio(){
  if(!qiblaAudioCtx)qiblaAudioCtx=new(window.AudioContext||window.webkitAudioContext)();
  if(qiblaAudioCtx.state==='suspended')qiblaAudioCtx.resume();
},{once:false});
document.addEventListener('click',function unlockAudio2(){
  if(!qiblaAudioCtx)qiblaAudioCtx=new(window.AudioContext||window.webkitAudioContext)();
  if(qiblaAudioCtx.state==='suspended')qiblaAudioCtx.resume();
});
function qiblaTick(){
  try{
    if(!qiblaAudioCtx)qiblaAudioCtx=new(window.AudioContext||window.webkitAudioContext)();
    if(qiblaAudioCtx.state==='suspended')qiblaAudioCtx.resume();
    const t=qiblaAudioCtx.currentTime;
    // Minute repeater chime â€” three tuned gong strikes
    const notes=[1047, 1319, 1568];
    const vol=0.075*(S.tickVol/100);
    notes.forEach((f,i)=>{
      const start=t+i*0.18;
      const o=qiblaAudioCtx.createOscillator();
      const g=qiblaAudioCtx.createGain();
      o.connect(g);g.connect(qiblaAudioCtx.destination);
      o.frequency.value=f;
      o.type='sine';
      // Sharp bell attack + long decay
      g.gain.setValueAtTime(vol*1.2,start);
      g.gain.exponentialRampToValueAtTime(vol*0.5,start+0.03);
      g.gain.exponentialRampToValueAtTime(0.001,start+1.4);
      o.start(start);o.stop(start+1.5);
      // Pure sine â€” no harmonics
    });
  }catch(e){}
}
function drawQiblaWindow(c){
  if(qiblaAngle===null)return;
  const qr=R*0.091;
  const midR=(R-R*0.18+R-R*0.03)/2;
  const qx=cx, qy=cy-midR;
  let arrowAng=deviceHeading!==null?qiblaAngle-deviceHeading:0; // no gyro: point up (12 o'clock)
  let normAng=arrowAng%(Math.PI*2);
  if(normAng>Math.PI)normAng-=Math.PI*2;
  if(normAng<-Math.PI)normAng+=Math.PI*2;
  const aligned=deviceHeading!==null&&Math.abs(normAng)<(5*Math.PI/180);
  qiblaAligned=aligned;
  const pulse=aligned?Math.sin(Date.now()*0.006)*0.5+0.5:0;
  if(aligned&&!qiblaWasAligned){qiblaTick();if(navigator.vibrate)navigator.vibrate(50);}
  qiblaWasAligned=aligned;
  ctx.save();
  // Shadow (same as hour marker shadow)
  ctx.fillStyle=c.shadow;
  ctx.shadowColor=c.shadow;ctx.shadowBlur=6*dpr;
  ctx.beginPath();ctx.arc(qx+3*dpr,qy+4*dpr,qr,0,Math.PI*2);ctx.fill();
  ctx.shadowBlur=0;
  // Metal casing (matches hour marker outer shell)
  ctx.fillStyle=c.hand;
  ctx.beginPath();ctx.arc(qx,qy,qr,0,Math.PI*2);ctx.fill();
  // Thin dark edge for depth (matches hour markers)
  ctx.strokeStyle=c.shadow;ctx.lineWidth=0.5*dpr;
  ctx.beginPath();ctx.arc(qx,qy,qr,0,Math.PI*2);ctx.stroke();
  // Lume fill (matches hour marker lume insert)
  const lumeR=qr*0.7;
  ctx.shadowColor=c.lume+'80';ctx.shadowBlur=10*dpr;
  ctx.fillStyle=aligned?'#4ade80':c.lume;
  ctx.beginPath();ctx.arc(qx,qy,lumeR,0,Math.PI*2);ctx.fill();
  ctx.shadowBlur=0;
  // Aligned glow
  if(aligned){
    ctx.shadowColor='#4ade80';ctx.shadowBlur=(16+pulse*8)*dpr;
    ctx.fillStyle='rgba(74,222,128,0.15)';
    ctx.beginPath();ctx.arc(qx,qy,qr+4*dpr,0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=0;
  }
  // Needle
  const nL=lumeR*0.85;
  const tipX=qx+Math.sin(arrowAng)*nL,tipY=qy-Math.cos(arrowAng)*nL;
  const tailX=qx-Math.sin(arrowAng)*nL*0.35,tailY=qy+Math.cos(arrowAng)*nL*0.35;
  const pX=Math.cos(arrowAng)*nL*0.24,pY=Math.sin(arrowAng)*nL*0.24;
  // Shadow
  ctx.fillStyle='rgba(0,0,0,0.45)';ctx.beginPath();
  ctx.moveTo(tipX+0.8*dpr,tipY+1.5*dpr);ctx.lineTo(tailX+pX+0.8*dpr,tailY+pY+1.5*dpr);
  ctx.lineTo(tailX-pX+0.8*dpr,tailY-pY+1.5*dpr);ctx.closePath();ctx.fill();
  // Body â€” red north needle for contrast against lume
  ctx.fillStyle=aligned?'#4ade80':'#c0392b';
  ctx.globalAlpha=1;
  ctx.beginPath();ctx.moveTo(tipX,tipY);
  ctx.lineTo(tailX+pX,tailY+pY);ctx.lineTo(tailX-pX,tailY-pY);
  ctx.closePath();ctx.fill();
  // Dark outline for contrast against lume
  ctx.strokeStyle='rgba(0,0,0,0.4)';ctx.lineWidth=0.8*dpr;
  ctx.beginPath();ctx.moveTo(tipX,tipY);
  ctx.lineTo(tailX+pX,tailY+pY);ctx.lineTo(tailX-pX,tailY-pY);
  ctx.closePath();ctx.stroke();
  // Bright edge highlight
  ctx.strokeStyle='rgba(255,255,255,0.25)';ctx.lineWidth=0.5*dpr;
  ctx.beginPath();ctx.moveTo(tipX,tipY);ctx.lineTo(tailX+pX,tailY+pY);ctx.stroke();
  ctx.globalAlpha=1;
  ctx.restore();
}

// â”€â”€ Split-Flap Countdown â”€â”€
let flapPrevChars=[],flapCharAnims=[];
const FLAP_DUR=350; // ms per character flip
const FLAP_STAGGER=60; // ms stagger between characters
// Tawaf flap racing state
let flapTawafActive=false,flapTawafStart=0,flapTawafLanded=false;
let flapLastClickCycle=0;
const FLAP_RACE_DIGITS='0123456789';
// Split-flap click â€” uses quartz tick sound (loud=true path)
function playFlapClick(intensity){
  try{
    if(!qiblaAudioCtx)return;
    if(qiblaAudioCtx.state==='suspended')qiblaAudioCtx.resume();
    const t=qiblaAudioCtx.currentTime;
    const sr=qiblaAudioCtx.sampleRate;
    const dur=0.018;
    const bufLen=Math.floor(sr*dur);
    const buf=qiblaAudioCtx.createBuffer(1,bufLen,sr);
    const data=buf.getChannelData(0);
    const vol=intensity*(S.tickVol/100);
    for(let i=0;i<bufLen;i++){
      const t2=i/sr;
      const env=Math.exp(-t2*600);
      data[i]=((i<3?1:0)*0.4+(Math.random()*2-1)*0.6)*env;
    }
    const src=qiblaAudioCtx.createBufferSource();src.buffer=buf;
    const g=qiblaAudioCtx.createGain();g.gain.value=vol;
    src.connect(g);g.connect(qiblaAudioCtx.destination);
    src.start(t);src.stop(t+dur+0.01);
  }catch(e){}
}
function drawSplitFlap(c){
  if(!PD)return;
    const isRam=devRamadan||(DD&&DD.hijri.month.number===9);
  // Show flap: always during Ramadan, Mon/Thu (Sunnah fasting), or dev mode
  const dayOfWeek=new Date().getDay(); // 0=Sun,1=Mon,...4=Thu
  const isSunnahDay=dayOfWeek===1||dayOfWeek===4;
  // Always show during dev period â€” revert after Ramadan launch
  const showFlap=true;
  if(!showFlap)return;

  // During tawaf: flap follows the spinning hands
  if(tawafState==='spinning'||tawafState==='hold'){
    if(!flapTawafActive){flapTawafActive=true;flapTawafStart=performance.now();flapTawafLanded=false;flapLastClickCycle=-1;tawafCurrentVM=0;}
    const landed=tawafState==='hold';
    if(landed&&!flapTawafLanded){flapTawafLanded=true;playFlapClick(1.0);playFlapClick(1.0);}
    let displayChars;
    if(landed){
      displayChars=['0','0',':','0','0'];
    }else{
      // Show the virtual time the hands are displaying
      const magMin=tawafMaghribMin||pM(PD.Maghrib);
      let virtMin=magMin-tawafCurrentVM;
      // Normalize to 0-1440
      while(virtMin<0)virtMin+=1440;
      virtMin=virtMin%1440;
      const hh=Math.floor(virtMin/60)%12||12;
      const mm=Math.floor(virtMin%60);
      displayChars=[
        String(Math.floor(hh/10)),String(hh%10),
        ':',
        String(Math.floor(mm/10)),String(mm%10)
      ];
      // Click sound synced to minute changes on the flap
      const clickCycle=Math.floor(tawafCurrentVM/2); // click every ~2 virtual minutes
      if(clickCycle>flapLastClickCycle){
        flapLastClickCycle=clickCycle;
        const intensity=0.3+0.7*Math.min(tawafCurrentVM/5040,1);
        playFlapClick(intensity);
      }
    }
    drawSplitFlapChars(c,displayChars,landed?'IFTAR MUBARAK':'');
    return;
  }else{
    if(flapTawafActive){flapTawafActive=false;flapTawafLanded=false;}
  }

  const fajr=pM(PD.Fajr),mag=pM(PD.Maghrib),now=nM();
  let label='',mins=0;
  const sunnahTag=!isRam&&isSunnahDay?' Â· SUNNAH':'';
  if(now>=fajr&&now<mag){mins=mag-now;label='IFTAR'+sunnahTag;}
  else if(now<fajr){mins=fajr-now;label='FAJR'+sunnahTag;}
  else{
    const endLabel=isRam?'IFTAR MUBARAK':'MAGHRIB';
    drawSplitFlapChars(c,['0','0',':','0','0'],endLabel);
    return;
  }
  const h=Math.floor(mins/60),m=Math.floor(mins%60);
  const chars=[
    String(Math.floor(h/10)),String(h%10),
    ':',
    String(Math.floor(m/10)),String(m%10)
  ];
  // Detect per-char changes
  const nowMs=performance.now();
  // Pad arrays to same length
  while(flapPrevChars.length<chars.length)flapPrevChars.push('');
  while(flapCharAnims.length<chars.length)flapCharAnims.push({t:1,prev:''});
  let changed=false;
  for(let i=0;i<chars.length;i++){
    if(chars[i]!==flapPrevChars[i]){
      flapCharAnims[i]={start:nowMs+i*FLAP_STAGGER,prev:flapPrevChars[i]||chars[i]};
      // Schedule click sound at the stagger time
      if(chars[i]!==':'){
        setTimeout(()=>playFlapClick(0.6),i*FLAP_STAGGER);
        changed=true;
      }
    }
  }
  flapPrevChars=chars.slice();
  // Trim excess
  flapCharAnims.length=chars.length;
  drawSplitFlapChars(c,chars,label);
}
function drawSplitFlapChars(c,chars,sub){
  const wy=cy+R*0.38;
  const digitW=R*0.058; // width per digit cell
  const colonW=R*0.025; // narrow colon column
  const cellGap=R*0.005; // gap between cells
  const cellH=R*0.1;
  // Compute total width with per-char widths
  const charWidths=chars.map(ch=>ch===':'?colonW:ch===' '?cellGap*2:digitW);
  const totalW=charWidths.reduce((a,w)=>a+w,0)+(chars.length-1)*cellGap;
  const startX=cx-totalW/2;
  const gap=0.8*dpr;
  const halfH=cellH/2-gap/2;
  const wr=R*0.012;
  const nowMs=performance.now();
  const fontSize=R*0.062;

  ctx.save();

  // Sub-label below
  ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.font=`500 ${R*0.024}px 'Inter',system-ui,sans-serif`;
  ctx.fillStyle=c.lume;ctx.globalAlpha=0.3;
  ctx.fillText(sub,cx,wy+cellH/2+R*0.028);
  ctx.globalAlpha=1;

  let curX=startX;
  for(let i=0;i<chars.length;i++){
    const ch=chars[i];
    const charW=charWidths[i];
    const cellX=curX;
    const cellCx=cellX+charW/2;
    const anim=flapCharAnims[i]||{start:0,prev:ch};
    const elapsed=nowMs-(anim.start||0);
    const t=Math.min(Math.max(elapsed/FLAP_DUR,0),1);
    if(ch===' '){curX+=charW+cellGap;continue;}
    // Colon: render as two dots, no cell
    if(ch===':'){
      const dotR=R*0.006;
      ctx.fillStyle=c.lume;ctx.globalAlpha=0.5;
      ctx.beginPath();ctx.arc(cellCx,wy-cellH*0.18,dotR,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.arc(cellCx,wy+cellH*0.18,dotR,0,Math.PI*2);ctx.fill();
      ctx.globalAlpha=1;
      curX+=charW+cellGap;continue;
    }

    // â”€â”€ Cell shadow â”€â”€
    ctx.fillStyle=c.shadow;
    roundRect(ctx,cellX+0.5*dpr,wy-cellH/2+1*dpr,charW,cellH,wr);ctx.fill();

    // â”€â”€ Cell background â”€â”€
    ctx.fillStyle='rgba(0,0,0,0.35)';
    roundRect(ctx,cellX,wy-cellH/2,charW,cellH,wr);ctx.fill();

    // â”€â”€ BOTTOM HALF â€” new char â”€â”€
    ctx.save();
    ctx.beginPath();
    ctx.rect(cellX,wy+gap/2,charW,halfH);ctx.clip();
    ctx.fillStyle='rgba(0,0,0,0.06)';
    ctx.fillRect(cellX,wy+gap/2,charW,halfH);
    ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.font=`600 ${fontSize}px 'Inter',system-ui,sans-serif`;
    ctx.fillStyle=c.lume;ctx.globalAlpha=0.9;
    ctx.fillText(ch,cellCx,wy);
    ctx.globalAlpha=1;
    ctx.restore();

    // â”€â”€ TOP HALF â€” new char (destination) â”€â”€
    ctx.save();
    ctx.beginPath();
    ctx.rect(cellX,wy-cellH/2,charW,halfH);ctx.clip();
    ctx.fillStyle='rgba(255,255,255,0.025)';
    ctx.fillRect(cellX,wy-cellH/2,charW,halfH);
    ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.font=`600 ${fontSize}px 'Inter',system-ui,sans-serif`;
    ctx.fillStyle=c.lume;ctx.globalAlpha=0.9;
    ctx.fillText(ch,cellCx,wy);
    ctx.globalAlpha=1;
    ctx.restore();

    // â”€â”€ FLIPPING FLAP â€” old char falling â”€â”€
    if(t<1&&anim.prev){
      const ease=t<0.5?2*t*t:1-Math.pow(-2*t+2,2)/2;
      const scaleY=Math.cos(ease*(Math.PI/2));
      if(scaleY>0.01){
        ctx.save();
        ctx.translate(cellCx,wy);
        ctx.scale(1,scaleY);
        ctx.translate(-cellCx,-wy);
        ctx.beginPath();
        ctx.rect(cellX,wy-halfH,charW,halfH);ctx.clip();
        ctx.fillStyle=`rgba(0,0,0,${0.35+0.2*ease})`;
        ctx.fillRect(cellX,wy-halfH,charW,halfH);
        ctx.fillStyle=`rgba(255,255,255,${0.025*(1-ease)})`;
        ctx.fillRect(cellX,wy-halfH,charW,halfH);
        ctx.textAlign='center';ctx.textBaseline='middle';
        ctx.font=`600 ${fontSize}px 'Inter',system-ui,sans-serif`;
        ctx.fillStyle=c.lume;ctx.globalAlpha=0.85*(1-ease*0.3);
        ctx.fillText(anim.prev,cellCx,wy);
        ctx.globalAlpha=1;
        ctx.restore();
      }
      // Shadow on bottom half from falling flap
      ctx.save();
      ctx.beginPath();ctx.rect(cellX,wy,charW,halfH);ctx.clip();
      const sH=halfH*0.35*(1-ease);
      const gr=ctx.createLinearGradient(cellCx,wy,cellCx,wy+sH);
      gr.addColorStop(0,`rgba(0,0,0,${0.25*(1-ease)})`);
      gr.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=gr;ctx.fillRect(cellX,wy,charW,sH);
      ctx.restore();
    }

    // â”€â”€ Split line + hinge â”€â”€
    ctx.fillStyle='rgba(0,0,0,0.5)';
    ctx.fillRect(cellX,wy-gap/2,charW,gap);
    ctx.fillStyle='rgba(255,255,255,0.04)';
    ctx.fillRect(cellX,wy+gap/2,charW,0.5*dpr);

    // â”€â”€ Cell border â”€â”€
    ctx.strokeStyle='rgba(255,255,255,0.05)';
    ctx.lineWidth=0.5*dpr;
    roundRect(ctx,cellX,wy-cellH/2,charW,cellH,wr);ctx.stroke();

    curX+=charW+cellGap;
  }

  ctx.restore();
}

// â”€â”€ Drawing â”€â”€
const ARABIC=['Ù¡Ù¢','Ù¡','Ù¢','Ù£','Ù¤','Ù¥','Ù¦','Ù§','Ù¨','Ù©','Ù¡Ù ','Ù¡Ù¡'];
const WESTERN=['12','1','2','3','4','5','6','7','8','9','10','11'];
const MIN_LABELS=['60','','','','','05','','','','','10','','','','','15','','','','','20','','','','','25','','','','','30','','','','','35','','','','','40','','','','','45','','','','','50','','','','','55','','','',''];

function roundRect(c,x,y,w,h,r){
  c.beginPath();c.moveTo(x+r,y);c.lineTo(x+w-r,y);c.quadraticCurveTo(x+w,y,x+w,y+r);
  c.lineTo(x+w,y+h-r);c.quadraticCurveTo(x+w,y+h,x+w-r,y+h);c.lineTo(x+r,y+h);
  c.quadraticCurveTo(x,y+h,x,y+h-r);c.lineTo(x,y+r);c.quadraticCurveTo(x,y,x+r,y);c.closePath();
}

// â”€â”€ Celestial: Stars + Moon â”€â”€
// Star field (generated once)
const STARS=[];
for(let i=0;i<200;i++){
  STARS.push({
    x:Math.random(),y:Math.random(), // full screen including watch face
    r:Math.random()*1.2+0.4,
    speed:Math.random()*0.002+0.0008,
    offset:Math.random()*Math.PI*2,
    bright:Math.random()*0.4+0.6
  });
}
let celestialProgress=0; // 0=hidden, 1=full. Smooth-animated.
let celestialTarget=0;

function drawStars(c){
  if(celestialProgress<0.01)return;
  const now=Date.now();
  const fadeIn=Math.min(celestialProgress*1.5,1);
  const twinkleAmt=Math.max(0,(celestialProgress-0.7)/0.3);
  ctx.save();
  STARS.forEach(s=>{
    const sx=s.x*W,sy=s.y*H;
    const twinkle=twinkleAmt>0.01?(1-twinkleAmt*0.6)+twinkleAmt*0.6*Math.sin(now*s.speed+s.offset):1;
    // Skip stars on the watch face
    const dist=Math.hypot(sx-cx,sy-cy);
    if(dist<R*1.05)return; // clear of the dial
    const a=fadeIn*s.bright*twinkle*0.7;
    ctx.fillStyle=`rgba(255,255,240,${Math.min(a,1)})`;
    ctx.shadowColor='rgba(255,255,240,0.3)';ctx.shadowBlur=3*dpr;
    ctx.beginPath();ctx.arc(sx,sy,s.r*dpr,0,Math.PI*2);ctx.fill();
  });
  ctx.shadowBlur=0;ctx.restore();
}

function getMoonPhase(){
  if(!DD)return 0.5;
  const day=parseInt(DD.hijri.day)||15;
  // 0=new, 0.5=full, 1=new again
  return day/29.5;
}

function drawMoon(c){
  if(celestialProgress<0.01)return;
  const moonR=R*0.13;
  // Moon rises from behind clock (bottom-right) to above (top-right)
  // Progress 0â†’1: y goes from cy+R*0.3 (behind clock) to cy-R*1.45 (above)
  const startY=cy+R*0.3, endY=cy-R*1.45;
  const startX=cx+R*0.6, endX=cx+R*0.55;
  // Ease the rise: fast out of clock, gentle settle at top
  const riseEase=1-Math.pow(1-celestialProgress,3);
  const moonX=startX+(endX-startX)*riseEase;
  const moonY=startY+(endY-startY)*riseEase;

  ctx.save();
  // Moon starts dim, brightens to full by animation end
  const moonBrightness=0.15+0.85*celestialProgress;
  ctx.globalAlpha=celestialProgress*moonBrightness;

  // Clip: exclude clock face so moon appears to rise from behind
  ctx.beginPath();
  ctx.rect(0,0,W,H);
  ctx.arc(cx,cy,R*1.02,0,Math.PI*2,true); // CCW = cut hole
  ctx.clip();

  // Moon glow
  const glowGrad=ctx.createRadialGradient(moonX,moonY,moonR*0.5,moonX,moonY,moonR*3);
  glowGrad.addColorStop(0,'rgba(255,248,220,0.15)');
  glowGrad.addColorStop(1,'rgba(255,248,220,0)');
  ctx.fillStyle=glowGrad;
  ctx.beginPath();ctx.arc(moonX,moonY,moonR*3,0,Math.PI*2);ctx.fill();

  // Moon body
  ctx.fillStyle='#f5f0d8';
  ctx.shadowColor='rgba(255,248,220,0.4)';ctx.shadowBlur=20*dpr;
  ctx.beginPath();ctx.arc(moonX,moonY,moonR,0,Math.PI*2);ctx.fill();
  ctx.shadowBlur=0;

  // Phase shadow
  const phase=getMoonPhase(); // 0=new, 0.5=full, 1=new
  const illum=phase<=0.5?phase*2:(1-phase)*2; // 0=new, 1=full
  if(illum<0.99){
    ctx.fillStyle='rgba(10,10,20,0.88)';
    ctx.beginPath();
    // Shadow side: waxing = right lit (shadow left), waning = left lit (shadow right)
    const waxing=phase<=0.5;
    // Half circle on shadow side
    ctx.arc(moonX,moonY,moonR,waxing?Math.PI/2:-Math.PI/2,waxing?-Math.PI/2:Math.PI/2,!waxing);
    // Terminator: ellipse width based on illumination
    const tw=moonR*(1-illum*2); // negative when >50% lit
    if(illum<0.5){
      // Less than half lit: shadow bulges into lit side
      ctx.ellipse(moonX,moonY,moonR*Math.abs(1-illum*2),moonR,0,
        waxing?-Math.PI/2:Math.PI/2,waxing?Math.PI/2:-Math.PI/2,waxing);
    }else{
      // More than half lit: shadow recedes
      ctx.ellipse(moonX,moonY,moonR*Math.abs(1-illum*2),moonR,0,
        waxing?-Math.PI/2:Math.PI/2,waxing?Math.PI/2:-Math.PI/2,!waxing);
    }
    ctx.fill();
  }

  // Surface texture: subtle craters
  ctx.globalAlpha=celestialProgress*0.08;
  const craters=[[0.3,-0.2,0.15],[-0.15,0.25,0.1],[-0.25,-0.1,0.08],[0.1,0.3,0.12],[0.2,0.1,0.06]];
  craters.forEach(([ox,oy,or])=>{
    ctx.fillStyle='rgba(0,0,0,0.5)';
    ctx.beginPath();ctx.arc(moonX+ox*moonR,moonY+oy*moonR,or*moonR,0,Math.PI*2);ctx.fill();
  });

  ctx.restore();
}

function drawFace(c){
  ctx.fillStyle=c.bg;
  ctx.fillRect(0,0,W,H);
  
  // Night mode: dial face glows like lume
  if(modeBlend>0.01){
    const glow=modeBlend;
    // Radial glow from center â€” the face IS the lume
    const grad=ctx.createRadialGradient(cx,cy,R*0.1,cx,cy,R*1.1);
    const lc=LUME_COLORS[S.lumeColor].color;
    const r=parseInt(lc.slice(1,3),16),g=parseInt(lc.slice(3,5),16),b=parseInt(lc.slice(5,7),16);
    grad.addColorStop(0,`rgba(${r},${g},${b},${0.06*glow})`);
    grad.addColorStop(0.6,`rgba(${r},${g},${b},${0.03*glow})`);
    grad.addColorStop(1,`rgba(${r},${g},${b},0)`);
    ctx.fillStyle=grad;
    ctx.fillRect(0,0,W,H);
  }
  
  // Subtle stipple texture (reduce in night mode)
  ctx.globalAlpha=celestialProgress>0.5?0.004:0.012;
  for(let i=0;i<600;i++){
    const x=Math.random()*W,y=Math.random()*H;
    ctx.fillStyle=Math.random()>0.5?'#fff':'#000';
    ctx.fillRect(x,y,dpr,dpr);
  }
  ctx.globalAlpha=1;
}

function drawIndices(c){
  for(let i=0;i<60;i++){
    const ang=(i/60)*Math.PI*2-Math.PI/2;
    const isHour=i%5===0;
    // Skip 12 o'clock â€” qibla compass replaces it
    if(i===0&&qiblaAngle!==null)continue;
    if(isHour){
      const inner=R-R*0.18,outer=R-R*0.03,capW=R*0.035;
      const midR=(inner+outer)/2;
      const capH=outer-inner;
      // Shadow
      ctx.save();
      ctx.translate(cx+Math.cos(ang)*midR+3*dpr,cy+Math.sin(ang)*midR+4*dpr);
      ctx.rotate(ang+Math.PI/2);
      ctx.fillStyle=c.shadow;
      ctx.shadowColor=c.shadow;ctx.shadowBlur=6*dpr;
      roundRect(ctx,-capW,capH/-2,capW*2,capH,capW);ctx.fill();
      ctx.shadowBlur=0;ctx.restore();
      // Metal casing (outer shell)
      ctx.save();
      ctx.translate(cx+Math.cos(ang)*midR,cy+Math.sin(ang)*midR);
      ctx.rotate(ang+Math.PI/2);
      // Clean metal capsule with lume insert
      // Outer metal shell
      ctx.fillStyle=c.hand;
      roundRect(ctx,-capW,capH/-2,capW*2,capH,capW);ctx.fill();
      // Thin dark edge for depth
      ctx.strokeStyle=c.shadow;ctx.lineWidth=0.5*dpr;
      roundRect(ctx,-capW,capH/-2,capW*2,capH,capW);ctx.stroke();
      // Lume insert (inset strip)
      const insetW=capW*0.55,insetH=capH*0.75;
      ctx.shadowColor=c.lume+'80';ctx.shadowBlur=10*dpr;
      ctx.fillStyle=c.lume;
      roundRect(ctx,-insetW,insetH/-2,insetW*2,insetH,insetW);ctx.fill();
      ctx.shadowBlur=0;
      // Lume glow highlight
      ctx.fillStyle='rgba(255,255,240,.3)';
      roundRect(ctx,-insetW*0.4,insetH/-2+1*dpr,insetW*0.8,insetH*0.4,insetW*0.3);ctx.fill();
      ctx.restore();
    }else{
      // Minute ticks
      const inner=R-R*0.07,outer=R-R*0.03;
      ctx.strokeStyle=c.shadow;ctx.lineWidth=2*dpr;ctx.lineCap='round';
      ctx.beginPath();ctx.moveTo(cx+Math.cos(ang)*inner+1*dpr,cy+Math.sin(ang)*inner+1.5*dpr);
      ctx.lineTo(cx+Math.cos(ang)*outer+1*dpr,cy+Math.sin(ang)*outer+1.5*dpr);ctx.stroke();
      ctx.strokeStyle=c.lume;ctx.globalAlpha=0.45;ctx.lineWidth=1.5*dpr;
      ctx.beginPath();ctx.moveTo(cx+Math.cos(ang)*inner,cy+Math.sin(ang)*inner);
      ctx.lineTo(cx+Math.cos(ang)*outer,cy+Math.sin(ang)*outer);ctx.stroke();
      ctx.globalAlpha=1;
    }
  }
}

function drawNumerals(c){
  if(S.numerals==='none')return;
  const showA=S.numerals==='arabic'||S.numerals==='both';
  const showW=S.numerals==='western'||S.numerals==='both';
  for(let i=0;i<12;i++){
    const ang=(i/12)*Math.PI*2-Math.PI/2;
    if(showA&&showW){
      const rA=R-R*0.3,rW=R-R*0.42;
      ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.font=`700 ${R*0.13}px Lateef,system-ui,sans-serif`;
      ctx.fillStyle=c.shadow;ctx.fillText(ARABIC[i],cx+Math.cos(ang)*rA+1.5*dpr,cy+Math.sin(ang)*rA+2*dpr);
      ctx.fillStyle=c.lume;ctx.shadowColor=c.lume+'40';ctx.shadowBlur=8*dpr;
      ctx.fillText(ARABIC[i],cx+Math.cos(ang)*rA,cy+Math.sin(ang)*rA);ctx.shadowBlur=0;
      ctx.font=`400 ${R*0.05}px Inter,system-ui,sans-serif`;ctx.fillStyle=c.lumeDim;
      ctx.fillText(WESTERN[i],cx+Math.cos(ang)*rW,cy+Math.sin(ang)*rW);
    }else{
      const r=R-R*0.32;const nums=showA?ARABIC:WESTERN;
      ctx.textAlign='center';ctx.textBaseline='middle';
      const isArabicNums=showA;
      ctx.font=isArabicNums?`700 ${R*0.14}px Lateef,system-ui,sans-serif`:`700 ${R*0.11}px Inter,system-ui,sans-serif`;
      ctx.fillStyle=c.shadow;ctx.fillText(nums[i],cx+Math.cos(ang)*r+1.5*dpr,cy+Math.sin(ang)*r+2*dpr);
      ctx.fillStyle=c.lume;ctx.shadowColor=c.lume+'40';ctx.shadowBlur=10*dpr;
      ctx.fillText(nums[i],cx+Math.cos(ang)*r,cy+Math.sin(ang)*r);ctx.shadowBlur=0;
    }
  }
  for(let i=0;i<60;i+=5){
    const ang=(i/60)*Math.PI*2-Math.PI/2;
    const r=R+R*0.06;const label=MIN_LABELS[i];if(!label)continue;
    ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.font=`500 ${R*0.045}px Inter,system-ui,sans-serif`;
    ctx.fillStyle=c.minNum;ctx.fillText(label,cx+Math.cos(ang)*r,cy+Math.sin(ang)*r);
  }
}

function drawFastingArc(c){
  if(!PD)return;
  const fajr=pM(PD.Fajr),mag=pM(PD.Maghrib),now=nM();
  // Use duration-based sweep so arc always covers the correct span on 12h clock
  const startAng=((fajr%720)/720)*Math.PI*2-Math.PI/2;
  const fastDur=mag-fajr; // fasting duration in minutes
  const sweepAng=(fastDur/720)*Math.PI*2;
  const endAng=startAng+sweepAng;
  const arcR=R+R*0.14;
  ctx.strokeStyle=colAlpha(c.accent,0.1);ctx.lineWidth=1*dpr;ctx.lineCap='round';
  ctx.beginPath();ctx.arc(cx,cy,arcR,startAng,endAng);ctx.stroke();
  if(now>=fajr&&now<=mag){
    const elapsed=now-fajr;
    const nowAng=startAng+(elapsed/720)*Math.PI*2;
    ctx.strokeStyle=colAlpha(c.accent,0.3);ctx.lineWidth=4*dpr;ctx.lineCap='round';
    ctx.beginPath();ctx.arc(cx,cy,arcR,startAng,nowAng);ctx.stroke();
    ctx.fillStyle=c.accent;ctx.shadowColor=colAlpha(c.accent,0.45);ctx.shadowBlur=10*dpr;
    ctx.beginPath();ctx.arc(cx+Math.cos(nowAng)*arcR,cy+Math.sin(nowAng)*arcR,3.5*dpr,0,Math.PI*2);ctx.fill();
    // For fasts >12h (Nordic summer), arc will wrap past the start point
    ctx.shadowBlur=0;
  }
}

function drawPrayerMarkers(c){
  if(!PD)return;
  const midR=R*0.80;
  PN.forEach(name=>{
    const mins=pM(PD[name]);
    const ang=((mins%720)/720)*Math.PI*2-Math.PI/2;
    const mx=cx+Math.cos(ang)*midR, my=cy+Math.sin(ang)*midR;
    const dotR=3*dpr;
    // Shadow
    ctx.fillStyle=c.shadow;ctx.beginPath();
    ctx.arc(mx+1*dpr,my+1.5*dpr,dotR,0,Math.PI*2);ctx.fill();
    // Dot
    ctx.fillStyle=PC[name];ctx.globalAlpha=0.85;ctx.beginPath();
    ctx.arc(mx,my,dotR,0,Math.PI*2);ctx.fill();
    // Highlight
    ctx.fillStyle='rgba(255,255,240,.35)';ctx.beginPath();
    ctx.arc(mx-0.8*dpr,my-0.8*dpr,dotR*0.4,0,Math.PI*2);ctx.fill();
    ctx.globalAlpha=1;
  });
}

// â”€â”€ Watch tick audio (shares qiblaAudioCtx) â”€â”€
let lastTickStep=-1,tickEnabled=false;
function ensureTickCtx(){
  if(!qiblaAudioCtx)qiblaAudioCtx=new(window.AudioContext||window.webkitAudioContext)();
  if(qiblaAudioCtx.state==='suspended')qiblaAudioCtx.resume();
  tickEnabled=true;
}
document.addEventListener('touchstart',ensureTickCtx,{once:false});
document.addEventListener('click',ensureTickCtx);

let currentSecAngle=0;

function playTick(loud){
  if(!qiblaAudioCtx)return;
  if(qiblaAudioCtx.state==='suspended')qiblaAudioCtx.resume();
  const t=qiblaAudioCtx.currentTime;
  const sr=qiblaAudioCtx.sampleRate;
  const dur=loud?0.018:0.006;
  const bufLen=Math.floor(sr*dur);
  const buf=qiblaAudioCtx.createBuffer(1,bufLen,sr);
  const data=buf.getChannelData(0);
  
  const baseVol=loud?1.0:0.60;
  const vol=baseVol*(S.tickVol/100);
  
  for(let i=0;i<bufLen;i++){
    const t2=i/sr;
    if(loud){
      const env=Math.exp(-t2*600);
      data[i]=((i<3?1:0)*0.4+(Math.random()*2-1)*0.6)*env;
    }else{
      const env=Math.exp(-t2*400);
      const s1=Math.sin(2*Math.PI*2200*t2)*0.7;
      const s2=Math.sin(2*Math.PI*5800*t2)*0.3;
      const click=t2<0.0003?(Math.random()*2-1)*0.3:0;
      data[i]=(s1+s2+click)*env;
    }
  }
  
  const src=qiblaAudioCtx.createBufferSource();
  src.buffer=buf;
  const g=qiblaAudioCtx.createGain();
  g.gain.value=vol;
  
  // Spatial audio â€” tick follows second hand around the clock face
  // HRTF panner places sound in 3D space around listener's head
  const panner=qiblaAudioCtx.createPanner();
  panner.panningModel='HRTF';
  panner.distanceModel='inverse';
  panner.refDistance=1;
  panner.maxDistance=10;
  panner.rolloffFactor=1;
  // Map second hand angle to position on circle around listener
  // 12 = front (0,0,-1), 3 = right (1,0,0), 6 = behind (0,0,1), 9 = left (-1,0,0)
  // Correct HRTF mapping: secAngle is from +X axis, -PI/2 = 12 o'clock
  // Web Audio: +X = right, -Z = forward, +Z = behind
  // Clock: 12=forward, 3=right, 6=behind, 9=left
  // Convert: clockAngle = secAngle + PI/2 (0=12, PI/2=3, PI=6, 3PI/2=9)
  const spatialR=2;
  const clockAng=currentSecAngle+Math.PI/2;
  panner.positionX.setValueAtTime(Math.sin(clockAng)*spatialR,t);
  panner.positionY.setValueAtTime(0,t);
  panner.positionZ.setValueAtTime(-Math.cos(clockAng)*spatialR,t);
  
  src.connect(g);g.connect(panner);panner.connect(qiblaAudioCtx.destination);
  src.start(t);src.stop(t+dur+0.01);
}

function tickAudio(s,ms){
  if(S.movement==='digital')return;
  if(!qiblaAudioCtx)return;
  let step,rate;
  if(S.movement==='quartz'){
    step=s;rate=1;
  }else{
    step=Math.floor(s*8+ms/1000*8);rate=8;
  }
  if(step!==lastTickStep){
    // Quartz: louder single tick. Mechanical: softer rapid ticks
    playTick(S.movement==='quartz');
    lastTickStep=step;
  }
}

function drawHand(c,angle,length,width,taperTip,tail){
  const tipX=cx+Math.cos(angle)*length,tipY=cy+Math.sin(angle)*length;
  const tailX=tail?cx-Math.cos(angle)*tail:cx,tailY=tail?cy-Math.sin(angle)*tail:cy;
  const perpX=Math.cos(angle+Math.PI/2),perpY=Math.sin(angle+Math.PI/2);
  // Shadow
  ctx.save();ctx.translate(3*dpr,4*dpr);
  ctx.fillStyle=c.shadow;ctx.shadowColor=c.shadow;ctx.shadowBlur=6*dpr;
  ctx.beginPath();ctx.moveTo(tailX-perpX*width,tailY-perpY*width);
  ctx.lineTo(tipX-perpX*taperTip,tipY-perpY*taperTip);
  ctx.lineTo(tipX+perpX*taperTip,tipY+perpY*taperTip);
  ctx.lineTo(tailX+perpX*width,tailY+perpY*width);ctx.closePath();ctx.fill();
  ctx.shadowBlur=0;ctx.restore();
  // Bevel
  ctx.save();ctx.translate(0.8*dpr,1.2*dpr);
  ctx.fillStyle=c.lumeDim;ctx.beginPath();
  ctx.moveTo(tailX-perpX*width,tailY-perpY*width);ctx.lineTo(tipX-perpX*taperTip,tipY-perpY*taperTip);
  ctx.lineTo(tipX+perpX*taperTip,tipY+perpY*taperTip);ctx.lineTo(tailX+perpX*width,tailY+perpY*width);
  ctx.closePath();ctx.fill();ctx.restore();
  // Clean metal hand body
  ctx.fillStyle=c.hand;ctx.strokeStyle=c.shadow;ctx.lineWidth=0.5*dpr;
  ctx.beginPath();ctx.moveTo(tailX-perpX*width,tailY-perpY*width);
  ctx.lineTo(tipX-perpX*taperTip,tipY-perpY*taperTip);
  ctx.lineTo(tipX+perpX*taperTip,tipY+perpY*taperTip);
  ctx.lineTo(tailX+perpX*width,tailY+perpY*width);ctx.closePath();ctx.fill();ctx.stroke();
  // Lume insert strip (inset into metal)
  ctx.strokeStyle=c.lume;ctx.lineWidth=width*0.5;ctx.lineCap='round';
  ctx.shadowColor=c.lume+'60';ctx.shadowBlur=10*dpr;
  ctx.beginPath();ctx.moveTo(tailX+Math.cos(angle)*width*2,tailY+Math.sin(angle)*width*2);
  ctx.lineTo(tipX-Math.cos(angle)*taperTip*4,tipY-Math.sin(angle)*taperTip*4);ctx.stroke();
  ctx.shadowBlur=0;
  // Lume strip highlight
  ctx.strokeStyle='rgba(255,255,240,.2)';ctx.lineWidth=width*0.15;
  ctx.beginPath();ctx.moveTo(tailX+Math.cos(angle)*width*3,tailY+Math.sin(angle)*width*3);
  ctx.lineTo(tipX-Math.cos(angle)*taperTip*5,tipY-Math.sin(angle)*taperTip*5);ctx.stroke();
}

function drawHands(c){
  const now=devNow();
  const h0=now.getHours()%12,m0=now.getMinutes(),s0=now.getSeconds(),ms0=now.getMilliseconds();

  // Movement types
  let sec;
  if(S.movement==='quartz') sec=s0;
  else if(S.movement==='mechanical') sec=Math.floor(s0*8+ms0/1000*8)/8;
  else sec=s0+ms0/1000;

  // Tick audio â€” suppress during tawaf (hands aren't ticking normally)
  if(!tawafActive)try{tickAudio(s0,ms0);}catch(e){}

  let min=m0+sec/60;
  let hour=h0+min/60;

  // Tawaf: counter-clockwise, time accelerates â€” hands stay mechanically coupled
  const tawafVM=getTawafVirtualMin();
  if(tawafVM>0){
    // Subtract virtual time (CCW). Use fractional seconds for smooth second hand.
    const realTotalSec=h0*3600+m0*60+s0+ms0/1000;
    const virtualTotalSec=realTotalSec-tawafVM*60;
    // Normalize to 12h cycle
    const ns=((virtualTotalSec%43200)+43200)%43200;
    hour=ns/3600;
    min=(ns%3600)/60;
    // Second hand: use smooth fractional seconds (override movement mode during tawaf)
    sec=ns%60;
  }

  const hourAng=(hour/12)*Math.PI*2-Math.PI/2;
  const minAng=(min/60)*Math.PI*2-Math.PI/2;
  const secAng=(sec/60)*Math.PI*2-Math.PI/2;
  currentSecAngle=secAng;

  drawHand(c,hourAng,R*0.52,R*0.028,R*0.008,R*0.06);
  drawHand(c,minAng,R*0.72,R*0.022,R*0.005,R*0.08);

  // Second hand
  const secLen=R*0.78,secTailLen=R*0.18;
  ctx.save();ctx.translate(2*dpr,3*dpr);
  ctx.strokeStyle=c.shadow;ctx.lineWidth=2.5*dpr;ctx.lineCap='round';
  ctx.beginPath();ctx.moveTo(cx-Math.cos(secAng)*secTailLen,cy-Math.sin(secAng)*secTailLen);
  ctx.lineTo(cx+Math.cos(secAng)*secLen,cy+Math.sin(secAng)*secLen);ctx.stroke();ctx.restore();
  ctx.strokeStyle=c.handStroke;ctx.lineWidth=1.5*dpr;ctx.lineCap='round';
  ctx.beginPath();ctx.moveTo(cx-Math.cos(secAng)*secTailLen,cy-Math.sin(secAng)*secTailLen);
  ctx.lineTo(cx+Math.cos(secAng)*secLen,cy+Math.sin(secAng)*secLen);ctx.stroke();

  // Center cap
  ctx.save();ctx.fillStyle=c.shadow;
  ctx.beginPath();ctx.arc(cx+3*dpr,cy+4*dpr,R*0.04,0,Math.PI*2);ctx.fill();ctx.restore();
  ctx.save();ctx.shadowColor=c.shadow;ctx.shadowBlur=10*dpr;ctx.shadowOffsetY=3*dpr;
  ctx.fillStyle=c.hand;ctx.beginPath();ctx.arc(cx,cy,R*0.04,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;ctx.restore();
  ctx.fillStyle=c.lume;ctx.globalAlpha=0.3;
  ctx.beginPath();ctx.arc(cx,cy,R*0.032,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;
  ctx.fillStyle='rgba(255,255,245,.3)';
  ctx.beginPath();ctx.arc(cx-1*dpr,cy-1.5*dpr,R*0.015,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#444';
  ctx.beginPath();ctx.arc(cx,cy,R*0.012,0,Math.PI*2);ctx.fill();
}

// â”€â”€ Tawaf (Iftar celebration) â”€â”€
// Counter-clockwise, hands maintain mechanical relationship, time accelerates
// 7 laps of the minute hand = 7 hours of virtual time, compressed into ~28s
let tawafActive=false,tawafStart=0,tawafDev=false;
// Tawaf sound always on
const TAWAF_LAPS=7,TAWAF_DURATION=14000; // 14s â€” two seconds per revolution
let tawafLastLap=-1;
function getTawafVirtualMin(){
  // Returns extra virtual minutes to subtract from current time (CCW)
  if(!tawafActive)return 0;
  const elapsed=performance.now()-tawafStart;
  if(elapsed>=TAWAF_DURATION+500){
    // Extra 500ms for final gong to ring, then end
    tawafCurrentVM=5040;endTawafSpin();return 0;
  }
  const t=Math.min(elapsed/TAWAF_DURATION,1);
  // Linear â€” each revolution exactly 2 seconds, no easing
  const vm=Math.min(5040,5040*t);
  tawafCurrentVM=vm;
  // Gong AFTER each completed hour-hand revolution (720 virtual min = 12h)
  // Use threshold slightly below 720 to catch the 7th lap at vmâ‰ˆ5040
  const completedLaps=Math.min(TAWAF_LAPS,Math.floor((vm+1)/720));
  if(completedLaps>tawafLastLap){
    tawafLastLap=completedLaps;
    playTawafGong(completedLaps-1);
  }
  return vm;
}
// Oud pluck â€” warm string sound at each revolution (istilam at the Black Stone)
function playTawafGong(lap){
  try{
    if(!qiblaAudioCtx)return;
    if(qiblaAudioCtx.state==='suspended')qiblaAudioCtx.resume();
    const t=qiblaAudioCtx.currentTime;
    const vol=0.22*(S.tickVol/100);
    const freq=293.66; // D4 â€” oud open string tuning
    // Oud: integer harmonics with strong 2nd/3rd, triangle wave, warm body
    const partials=[
      {ratio:1,   amp:1.0,  decay:1.6},
      {ratio:2,   amp:0.55, decay:1.0},
      {ratio:3,   amp:0.35, decay:0.7},
      {ratio:4,   amp:0.15, decay:0.5},
      {ratio:5,   amp:0.06, decay:0.3},
    ];
    const bodyFilter=qiblaAudioCtx.createBiquadFilter();
    bodyFilter.type='peaking';bodyFilter.frequency.value=freq*1.5;
    bodyFilter.Q.value=2;bodyFilter.gain.value=4;
    bodyFilter.connect(qiblaAudioCtx.destination);
    partials.forEach(p=>{
      const o=qiblaAudioCtx.createOscillator();
      const g=qiblaAudioCtx.createGain();
      o.connect(g);g.connect(bodyFilter);
      // Slight upward pitch bend on attack (string stretch from pluck)
      o.frequency.setValueAtTime(freq*p.ratio*1.008,t);
      o.frequency.exponentialRampToValueAtTime(freq*p.ratio,t+0.03);
      o.type='triangle';
      const v=vol*p.amp;
      // Pluck envelope: instant attack â†’ fast snap â†’ gentle ring
      g.gain.setValueAtTime(0,t);
      g.gain.linearRampToValueAtTime(v,t+0.001);
      g.gain.exponentialRampToValueAtTime(v*0.35,t+0.06);
      g.gain.exponentialRampToValueAtTime(v*0.12,t+0.3);
      g.gain.exponentialRampToValueAtTime(0.001,t+p.decay);
      o.start(t);o.stop(t+p.decay+0.1);
    });
    // Pluck noise â€” finger on string transient
    const noiseDur=0.025;
    const noiseBuf=qiblaAudioCtx.createBuffer(1,Math.floor(qiblaAudioCtx.sampleRate*noiseDur),qiblaAudioCtx.sampleRate);
    const nd=noiseBuf.getChannelData(0);
    for(let i=0;i<nd.length;i++)nd[i]=(Math.random()*2-1)*Math.exp(-i/(nd.length*0.08));
    const ns=qiblaAudioCtx.createBufferSource();ns.buffer=noiseBuf;
    const ng=qiblaAudioCtx.createGain();ng.gain.value=vol*0.4;
    const bf=qiblaAudioCtx.createBiquadFilter();bf.type='highpass';bf.frequency.value=800;bf.Q.value=1;
    ns.connect(bf);bf.connect(ng);ng.connect(qiblaAudioCtx.destination);
    ns.start(t);ns.stop(t+noiseDur);
  }catch(e){}
}
// Tawaf states: idle â†’ (dev: pre_mag â†’) spinning â†’ hold â†’ idle
const TAWAF_HOLD_MS=10000; // 10s hold with normal ticking after tawaf
// Pre-compute: first gong hits when vm=720 (first hour-hand lap)
// With ease-out quadratic t*(2-t)=1/7: t = 1 - sqrt(1 - 1/7)
const TAWAF_PREGONG_T=1/7; // linear: first gong at exactly 1/7 of duration (2s)
const TAWAF_PREGONG_MS=TAWAF_PREGONG_T*TAWAF_DURATION; // 2s before first gong
const TAWAF_PRESTART_MIN=TAWAF_PREGONG_MS/1000/60; // in minutes
let tawafState='idle'; // idle | pre_mag | spinning | hold
let tawafHoldStart=0;
let tawafPreMagStart=0;
let tawafMaghribMin=null;
let tawafCurrentVM=0; // shared vm value for sync between gong + celestial
function startTawaf(fromDev){
  tawafLastLap=0;celestialProgress=0;modeBlend=0;modeTarget=0;
  if(fromDev&&PD){
    tawafMaghribMin=pM(PD.Maghrib);
    tawafDev=true;
    // Snap to 5 seconds before tawaf auto-trigger point
    devTimeMin=tawafMaghribMin-TAWAF_PRESTART_MIN-(5/60);
    tawafState='pre_mag';
    tawafPreMagStart=performance.now();
    // Don't start spinning â€” checkTawaf will auto-trigger when devTime reaches the pre-start mark
  }else{
    // Live trigger: already pre-started before Maghrib
    tawafActive=true;tawafStart=performance.now();
    tawafState='spinning';
  }
}
function endTawafSpin(){
  tawafActive=false;
  tawafState='hold';
  tawafHoldStart=performance.now();
  if(tawafDev&&tawafMaghribMin!==null){
    // Start hold at Maghrib, will tick forward naturally
    devTimeMin=tawafMaghribMin;
  }
}
function checkTawafHold(){
  if(tawafState!=='hold')return;
  // Normal ticking during hold: advance from Maghrib
  if(tawafDev&&tawafMaghribMin!==null){
    const holdElapsed=(performance.now()-tawafHoldStart)/1000/60;
    devTimeMin=tawafMaghribMin+holdElapsed;
    updateModeBlend(); // may transition to night at Maghrib
  }
  if(performance.now()-tawafHoldStart>=TAWAF_HOLD_MS){
    // Restore live time
    tawafState='idle';tawafDev=false;
    devTimeMin=null;tawafMaghribMin=null;celestialProgress=0;modeBlend=0;modeTarget=0;
    const sl=document.getElementById('devSlider');
    const lb=document.getElementById('devTimeLabel');
    const tg=document.getElementById('devTawafToggle');
    if(sl)sl.value=720;if(lb)lb.textContent='LIVE';if(tg)tg.checked=false;
    updateInfo();
  }
}
// Auto-trigger: start ~10s BEFORE Maghrib so first gong = Maghrib
let tawafTriggered=false;
function checkTawaf(){
  checkTawafHold();
  // Dev pre_mag: tick forward from 1min before Maghrib, auto-trigger at pre-start mark
  if(tawafState==='pre_mag'&&tawafMaghribMin!==null){
    const elapsed=(performance.now()-tawafPreMagStart)/1000/60; // real minutes elapsed
    devTimeMin=(tawafMaghribMin-TAWAF_PRESTART_MIN-(5/60))+elapsed;
    updateInfo();
    // When virtual time reaches the pre-start mark, begin spinning
    const preStart=tawafMaghribMin-TAWAF_PRESTART_MIN;
    if(devTimeMin>=preStart){
      tawafActive=true;tawafStart=performance.now();
      tawafState='spinning';
    }
    return;
  }
  if(tawafState!=='idle')return;
  if(!PD)return;
  const now=nM(),mag=pM(PD.Maghrib);
  const preStart=mag-TAWAF_PRESTART_MIN;
  if(now>=preStart&&now<mag+1&&!tawafTriggered){tawafTriggered=true;startTawaf(false);}
  if(now<preStart)tawafTriggered=false;
}

function draw(){
  if(S.mode==='auto')updateModeBlend();
  checkTawaf();
  const c=getColors();
  updatePixelShift();

  ctx.save();
  ctx.translate(pixelShiftX*dpr,pixelShiftY*dpr);

  ctx.clearRect(-10,-10,W+20,H+20);

  // Celestial: tied to tawaf gong timing
  // First gong at vm=720, last at vm=5040. Celestial maps across that range.
  if(tawafState==='spinning'&&tawafActive){
    // Use shared vm from getTawafVirtualMin â€” exact sync with gong timing
    const vm=tawafCurrentVM;
    // Celestial only starts AFTER first gong (vm>=720)
    celestialProgress=vm>=720?Math.min(1,(vm-720)/3600):0;
    // Night fade directly tracks celestial â€” no lerp lag
    modeTarget=celestialProgress;
    modeBlend=celestialProgress;
  }else if(tawafState==='hold'){
    celestialProgress=1;
    modeTarget=1;modeBlend+=(1-modeBlend)*0.08;
  }else if(tawafState==='pre_mag'){
    // Hold celestial at 0 during pre-mag countdown â€” prevent moon flash
    celestialProgress=0;modeBlend=0;modeTarget=0;
  }else{
    // Outside tawaf: celestial follows night mode
    const nightTarget=resolveMode()==='night'?1:0;
    celestialProgress+=(nightTarget-celestialProgress)*0.03;
    if(Math.abs(celestialProgress-nightTarget)<0.005)celestialProgress=nightTarget;
    updateModeBlend();
  }

  drawFace(c);
  drawStars(c); // behind everything
  drawFastingArc(c);
  drawQiblaWindow(c);
  drawSplitFlap(c);
  drawPrayerMarkers(c);
  drawIndices(c);
  drawNumerals(c);
  drawHands(c);
  drawMoon(c); // on top, clipped behind clock face

  ctx.restore();
  requestAnimationFrame(draw);
}

// â”€â”€ Tap to show/hide info â”€â”€
// â”€â”€ Dial Picker Bar â”€â”€
const DIAL_KEYS=Object.keys(DIALS);
function buildDialDots(){
  const container=document.getElementById('dialDots');
  container.innerHTML=DIAL_KEYS.map(key=>`<div class="dial-dot${key===S.dial?' active':''}"></div>`).join('');
}
window.pickDial=function(key){
  S.dial=key;
  localStorage.setItem('rc6',JSON.stringify(S));
  D=DIALS[key];
  applyThemeToUI();
  buildDialDots();
  document.getElementById('sDial').value=key;
};
function swipeDial(dir){
  const idx=DIAL_KEYS.indexOf(S.dial);
  const next=DIAL_KEYS[(idx+dir+DIAL_KEYS.length)%DIAL_KEYS.length];
  pickDial(next);
  showDots();
}
let dotTimer=null;
function showDots(){
  const dots=document.getElementById('dialDots');
  dots.classList.add('visible');
  clearTimeout(dotTimer);
  dotTimer=setTimeout(()=>dots.classList.remove('visible'),1500);
}
// Swipe detection
let swipeX0=null,swipeY0=null;
function handleSwipe(dx,dy){
  if(Math.abs(dx)>50&&Math.abs(dx)>Math.abs(dy)*1.5){
    swipeDial(dx<0?1:-1);
  }else if(Math.abs(dy)>50&&Math.abs(dy)>Math.abs(dx)*1.5){
    S.mode=dy<0?'day':'night';
    localStorage.setItem('rc6',JSON.stringify(S));
    updateModeBlend();
  }
}
// Touch
cv.addEventListener('touchstart',e=>{swipeX0=e.touches[0].clientX;swipeY0=e.touches[0].clientY;},{passive:true});
cv.addEventListener('touchend',e=>{
  if(swipeX0===null)return;
  const dx=e.changedTouches[0].clientX-swipeX0,dy=e.changedTouches[0].clientY-swipeY0;
  swipeX0=null;handleSwipe(dx,dy);
});
// Mouse (PC click-drag)
cv.addEventListener('mousedown',e=>{swipeX0=e.clientX;swipeY0=e.clientY;});
cv.addEventListener('mouseup',e=>{
  if(swipeX0===null)return;
  const dx=e.clientX-swipeX0,dy=e.clientY-swipeY0;
  swipeX0=null;handleSwipe(dx,dy);
});
buildDialDots();

let infoVisible=false, infoTimer=null;
function toggleInfo(){
  const els=document.querySelectorAll('.info');
  infoVisible=!infoVisible;
  els.forEach(el=>el.classList.toggle('visible',infoVisible));
  clearTimeout(infoTimer);
  if(infoVisible) infoTimer=setTimeout(()=>{
    infoVisible=false;
    els.forEach(el=>el.classList.remove('visible'));
  },6000);
}
cv.addEventListener('click',e=>{
  if(e.target.closest('.sov'))return;
  toggleInfo();
});

// â”€â”€ Init â”€â”€
updateModeBlend();
if(resolveMode()==='night')modeBlend=1; // no transition on load
D=getColors();
applyThemeToUI();
calcQibla(); // try city fallback immediately
fetchPrayer();
setInterval(fetchPrayer,30*60*1000);
setInterval(updateInfo,1000);
draw();
</script>
<div id="devPanel" style="display:none;position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:100;background:rgba(0,0,0,.85);backdrop-filter:blur(12px);border:1px solid rgba(240,224,96,.3);border-radius:12px;padding:14px 20px;gap:10px;flex-direction:column;align-items:center;font-family:'Inter',system-ui,sans-serif;font-size:12px;color:rgba(255,255,240,.8);min-width:320px;">
  <div style="display:flex;align-items:center;gap:8px;width:100%;">
    <span style="color:#f0e060;font-weight:600;font-size:11px;letter-spacing:.1em;">DEV MODE</span>
    <span style="flex:1"></span>
    <span id="devTimeLabel" style="font-variant-numeric:tabular-nums;font-weight:500;">LIVE</span>
  </div>
  <input type="range" id="devSlider" min="0" max="1439" step="0.5" value="720" style="width:100%;accent-color:#f0e060;cursor:pointer;" oninput="devTimeMin=parseFloat(this.value);document.getElementById('devTimeLabel').textContent=((h,m)=>(h%12||12)+':'+String(m).padStart(2,'0')+(h>=12?' PM':' AM'))(Math.floor(this.value/60),Math.floor(this.value%60));updateModeBlend();updateInfo();">
  <div style="display:flex;gap:8px;align-items:center;width:100%;margin-top:4px;">
    <span style="font-size:10px;color:rgba(255,255,240,.5);">Location</span>
    <select id="devLocSelect" onchange="devFetchLocation(this.value);" style="flex:1;font-size:11px;padding:4px 6px;background:rgba(240,224,96,.1);border:1px solid rgba(240,224,96,.25);border-radius:6px;color:#f0e060;cursor:pointer;">
      <option value="la">Los Angeles ðŸ‡ºðŸ‡¸ (~14h)</option>
      <option value="capetown">Cape Town ðŸ‡¿ðŸ‡¦ (~11h)</option>
      <option value="mecca">Mecca ðŸ‡¸ðŸ‡¦ (~14h)</option>
      <option value="london">London ðŸ‡¬ðŸ‡§ (~18h)</option>
      <option value="stockholm">Stockholm ðŸ‡¸ðŸ‡ª (~19h)</option>
      <option value="reykjavik">Reykjavik ðŸ‡®ðŸ‡¸ (~21h)</option>
    </select>
  </div>
  <div style="display:flex;gap:12px;align-items:center;width:100%;margin-top:4px;">
    <label style="display:flex;align-items:center;gap:6px;cursor:pointer;"><input type="checkbox" id="devRamToggle" onchange="devRamadan=this.checked;updateInfo();" style="accent-color:#f0e060;"> <span style="font-size:11px;">Ramadan</span></label>
    <label style="display:flex;align-items:center;gap:6px;cursor:pointer;"><input type="checkbox" id="devTawafToggle" onchange="if(this.checked){celestialProgress=0;modeBlend=0;modeTarget=0;startTawaf(true);}else{tawafActive=false;tawafDev=false;tawafState='idle';celestialProgress=0;modeBlend=0;modeTarget=0;devTimeMin=null;tawafMaghribMin=null;document.getElementById('devSlider').value=720;document.getElementById('devTimeLabel').textContent='LIVE';updateInfo();}" style="accent-color:#f0e060;"> <span style="font-size:11px;">Tawaf</span></label>
    <span style="flex:1"></span>
    <button onclick="devTimeMin=null;devLocation=null;devRamadan=false;tawafActive=false;tawafDev=false;tawafState='idle';tawafMaghribMin=null;celestialProgress=0;modeBlend=0;modeTarget=0;document.getElementById('devSlider').value=720;document.getElementById('devTimeLabel').textContent='LIVE';document.getElementById('devRamToggle').checked=false;document.getElementById('devTawafToggle').checked=false;document.getElementById('devLocSelect').value='la';fetchPrayer();" style="font-size:10px;padding:4px 10px;background:rgba(240,224,96,.15);border:1px solid rgba(240,224,96,.3);border-radius:6px;color:#f0e060;cursor:pointer;">Reset All</button>
  </div>
</div>
<script>
(function(){
  let lastTap=0;
  function toggleDev(){
    devMode=!devMode;
    document.getElementById('devPanel').style.display=devMode?'flex':'none';
    if(!devMode){devTimeMin=null;devRamadan=false;document.getElementById('devRamToggle').checked=false;document.getElementById('devSlider').value=720;document.getElementById('devTimeLabel').textContent='LIVE';updateInfo();}
  }
  document.addEventListener('dblclick',toggleDev);
  document.addEventListener('touchend',function(e){const now=Date.now();if(now-lastTap<350){e.preventDefault();toggleDev();}lastTap=now;});
})();
</script>
</body>
</html>
